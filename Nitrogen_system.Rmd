---
title: "Nsystem"
author: "Jianqiu Zheng"
date: "4/14/2021"
output: html_document
---
###full model with OM mineralization
```{r kin}
library(FME)

#pars<- list (v0=5, v1=2,v2=2,v3=4,v4=3,v5=1)
pars<- list (v0=1,v1=1,v2=1,v3=1,v4=1,v5=1, v6=1)
solveDnra <- function(pars, times=seq(0,50, by=0.05)){
 derivs <- function(t, state, pars){
      with(as.list(c(state, pars)),{
      r0<- v0 * CHO/(CHO+500) * Oxy/(Oxy+10)
      r1<- v1 * Amm/(Amm+10) * Oxy/(Oxy+10) # Amm oxidation by BM1
      r2<- v2 * Nat/(Nat+10) * DOC/(DOC+1) # Nitrate reduction to nitrite
      r3<- v3 * Nit/(Nit+10) * DOC/(DOC+1)  #denitrification
      r4<- v4 * Nit/(Nit+1) * DOC/(DOC+10)  #DNRA high affinity for nitrite
      r5<- v5 * Nit/(Nit+100) * Amm/(Amm+100)  #Anammox (low affinity)
      r6<- v6 * DOC/(DOC+10) * Oxy/(Oxy+10)
      rsum<-r0+r1+r2+r3+r4+r5+r6
      
      dAmm <-((20-Amm)*0.02-4.75*r1*r1/rsum+0.39*r4*r4/rsum-6.26*r5*r5/rsum+0.2*r6*r6/rsum+1/5.88*r0*r0/rsum)*BM
      dNat <-((20-Nat)*0.02-4.55*r1*r1/rsum-1.24*r2*r2/rsum)*BM
      dNit <-((0-Nit)*0.02+1.04*r2*r2/rsum-0.72*r3*r3/rsum-0.59*r4*r4/rsum-4.73*r5*r5/rsum)*BM
      dN2 <- (0.26*r3*r3/rsum+5.39*r5*r5/rsum)*BM
      dDOC <- ((40-DOC)*0.02-1.92*r2*r2/rsum-1.30*r3*r3/rsum-1.88*r4*r4/rsum-1.06*r6*r6/rsum+r0*r0/rsum)*BM
      dBM<-((0-BM)*0.02+r1*r1/rsum+r2*r2/rsum+r3*r3/rsum+r4*r4/rsum+r5*r5/rsum+r6*r6/rsum+r0*r0/rsum-0.1)*BM
      dOxy<- ((5-Oxy)*0.02-r0*r0/rsum-8.09*r1*r1/rsum-0.39*r6*r6/rsum)*BM #(5-Oxy)*0.02
      dCHO<--r0*r0/rsum*BM 
      
      R1<-r1/rsum #Nitrification
      R2<-r2/rsum #NO3 reduction
      R3<-r3/rsum #NO3 removal via DEN
      R4<-r4/rsum #NO3 removal via DNRA
      R5<-r5/rsum#NO3 removal via Ana
      R0<-r0/rsum
      R6<-r6/rsum
    return(list(c(dNat,dNit,dAmm,dN2,dCHO,dDOC,dOxy,dBM),R1,R2, R3, R4, R5, R0,R6))
      })
  }
times=seq(0,100, by=0.05)
state<-c(Nat=5,Nit=0, Amm=1, N2=0,CHO=200,DOC=20,Oxy=20,BM=2)
#solved the mode
  ox<-ode(y=state, times=times, func=derivs, parms=pars)

data.frame(ox[,1:16])
}

output<-solveDnra(pars)  

   

plot(output$time,output$Nit, type = "l",xlab = "Time (h)", ylab = "Concentration (mM)", lwd=3,col="#7f3b08", xlim=c(0,100), ylim=c(0,50))
lines(output$time,output$Amm, lwd=3, lty=1, col="#e08214")
lines(output$time,output$N2, lwd=3, lty=1, col="#542788")
lines(output$time,output$Nat, lwd=3, lty=1, col="black")
lines(output$time,output$DOC, lwd=3, lty=3, col="#11d05d")
legend("topright", c("NO2","NH4","N2","NO3","CHO"),lwd=3, lty=c(1,1,1,1,3), col=c("#7f3b08","#e08214","#542788","black","#11d05d"))

  
plot(output$time,output$X14, type = "l",xlab = "Time (d)", ylab = "control variables", lwd=3,col="#2d004b", xlim=c(0,100), ylim=c(0,1))
lines(output$time,output$X9, lwd=3, lty=1, col="#b35806")
lines(output$time,output$X10, lwd=3, lty=1, col="#fdb863")
lines(output$time,output$X11, lwd=3, lty=1, col="#fee0b6")
lines(output$time,output$X12, lwd=3, lty=1, col="#b2abd2")
lines(output$time,output$X13, lwd=3, lty=1, col="#8073ac")
lines(output$time,output$X15, lwd=3, lty=1, col="red")
legend("topright", c("OMM","Ni","NAR","DEN","DNRA","ANMX","res"),lwd=3, lty=c(1,1,1,1,1,1), col=c("#2d004b","#b35806","#fdb863","#fee0b6","#b2abd2","#8073ac","red"))


plot(output$time,output$BM, type = "l",xlab = "Time (h)", ylab = "Concentration (mM)", lwd=3,col="#2d004b", xlim=c(0,100), ylim=c(0,50))
legend("topright", c("OMM","Ni","NAR","DEN","DNRA","ANMX"),lwd=3, lty=c(1,1,1,1,1,1), col=c("#2d004b","#b35806","#fdb863","#fee0b6","#b2abd2","#8073ac","red"))


output[10001,]
```


